<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="mpark/wg21" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2025-09-03" />
  <title>Iterating on `parallel_scheduler`</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
      div.csl-block{margin-left: 1.5em;}
      ul.task-list{list-style: none;}
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {  background-color: #f6f8fa; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { } /* Normal */
      code span.al { color: #ff0000; } /* Alert */
      code span.an { } /* Annotation */
      code span.at { } /* Attribute */
      code span.bn { color: #9f6807; } /* BaseN */
      code span.bu { color: #9f6807; } /* BuiltIn */
      code span.cf { color: #00607c; } /* ControlFlow */
      code span.ch { color: #9f6807; } /* Char */
      code span.cn { } /* Constant */
      code span.co { color: #008000; font-style: italic; } /* Comment */
      code span.cv { color: #008000; font-style: italic; } /* CommentVar */
      code span.do { color: #008000; } /* Documentation */
      code span.dt { color: #00607c; } /* DataType */
      code span.dv { color: #9f6807; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #9f6807; } /* Float */
      code span.fu { } /* Function */
      code span.im { } /* Import */
      code span.in { color: #008000; } /* Information */
      code span.kw { color: #00607c; } /* Keyword */
      code span.op { color: #af1915; } /* Operator */
      code span.ot { } /* Other */
      code span.pp { color: #6f4e37; } /* Preprocessor */
      code span.re { } /* RegionMarker */
      code span.sc { color: #9f6807; } /* SpecialChar */
      code span.ss { color: #9f6807; } /* SpecialString */
      code span.st { color: #9f6807; } /* String */
      code span.va { } /* Variable */
      code span.vs { color: #9f6807; } /* VerbatimString */
      code span.wa { color: #008000; font-weight: bold; } /* Warning */
      code.diff {color: #898887}
      code.diff span.va {color: #006e28}
      code.diff span.st {color: #bf0303}
  </style>
  <style type="text/css">
body {
margin: 5em;
font-family: serif;

hyphens: auto;
line-height: 1.35;
text-align: justify;
}
@media screen and (max-width: 30em) {
body {
margin: 1.5em;
}
}
div.wrapper {
max-width: 60em;
margin: auto;
}
ul {
list-style-type: none;
padding-left: 2em;
margin-top: -0.2em;
margin-bottom: -0.2em;
}
a {
text-decoration: none;
color: #4183C4;
}
a.hidden_link {
text-decoration: none;
color: inherit;
}
li {
margin-top: 0.6em;
margin-bottom: 0.6em;
}
h1, h2, h3, h4 {
position: relative;
line-height: 1;
}
a.self-link {
position: absolute;
top: 0;
left: calc(-1 * (3.5rem - 26px));
width: calc(3.5rem - 26px);
height: 2em;
text-align: center;
border: none;
transition: opacity .2s;
opacity: .5;
font-family: sans-serif;
font-weight: normal;
font-size: 83%;
}
a.self-link:hover { opacity: 1; }
a.self-link::before { content: "§"; }
ul > li:before {
content: "\2014";
position: absolute;
margin-left: -1.5em;
}
:target { background-color: #C9FBC9; }
:target .codeblock { background-color: #C9FBC9; }
:target ul { background-color: #C9FBC9; }
.abbr_ref { float: right; }
.folded_abbr_ref { float: right; }
:target .folded_abbr_ref { display: none; }
:target .unfolded_abbr_ref { float: right; display: inherit; }
.unfolded_abbr_ref { display: none; }
.secnum { display: inline-block; min-width: 35pt; }
.header-section-number { display: inline-block; min-width: 35pt; }
.annexnum { display: block; }
div.sourceLinkParent {
float: right;
}
a.sourceLink {
position: absolute;
opacity: 0;
margin-left: 10pt;
}
a.sourceLink:hover {
opacity: 1;
}
a.itemDeclLink {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
opacity: 0;
}
a.itemDeclLink:hover { opacity: 1; }
span.marginalizedparent {
position: relative;
left: -5em;
}
li span.marginalizedparent { left: -7em; }
li ul > li span.marginalizedparent { left: -9em; }
li ul > li ul > li span.marginalizedparent { left: -11em; }
li ul > li ul > li ul > li span.marginalizedparent { left: -13em; }
div.footnoteNumberParent {
position: relative;
left: -4.7em;
}
a.marginalized {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
}
a.enumerated_item_num {
position: relative;
left: -3.5em;
display: inline-block;
margin-right: -3em;
text-align: right;
width: 3em;
}
div.para { margin-bottom: 0.6em; margin-top: 0.6em; text-align: justify; }
div.section { text-align: justify; }
div.sentence { display: inline; }
span.indexparent {
display: inline;
position: relative;
float: right;
right: -1em;
}
a.index {
position: absolute;
display: none;
}
a.index:before { content: "⟵"; }

a.index:target {
display: inline;
}
.indexitems {
margin-left: 2em;
text-indent: -2em;
}
div.itemdescr {
margin-left: 3em;
}
.bnf {
font-family: serif;
margin-left: 40pt;
margin-top: 0.5em;
margin-bottom: 0.5em;
}
.ncbnf {
font-family: serif;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
}
.ncsimplebnf {
font-family: serif;
font-style: italic;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
background: inherit; 
}
span.textnormal {
font-style: normal;
font-family: serif;
white-space: normal;
display: inline-block;
}
span.rlap {
display: inline-block;
width: 0px;
}
span.descr { font-style: normal; font-family: serif; }
span.grammarterm { font-style: italic; }
span.term { font-style: italic; }
span.terminal { font-family: monospace; font-style: normal; }
span.nonterminal { font-style: italic; }
span.tcode { font-family: monospace; font-style: normal; }
span.textbf { font-weight: bold; }
span.textsc { font-variant: small-caps; }
a.nontermdef { font-style: italic; font-family: serif; }
span.emph { font-style: italic; }
span.techterm { font-style: italic; }
span.mathit { font-style: italic; }
span.mathsf { font-family: sans-serif; }
span.mathrm { font-family: serif; font-style: normal; }
span.textrm { font-family: serif; }
span.textsl { font-style: italic; }
span.mathtt { font-family: monospace; font-style: normal; }
span.mbox { font-family: serif; font-style: normal; }
span.ungap { display: inline-block; width: 2pt; }
span.textit { font-style: italic; }
span.texttt { font-family: monospace; }
span.tcode_in_codeblock { font-family: monospace; font-style: normal; }
span.phantom { color: white; }

span.math { font-style: normal; }
span.mathblock {
display: block;
margin-left: auto;
margin-right: auto;
margin-top: 1.2em;
margin-bottom: 1.2em;
text-align: center;
}
span.mathalpha {
font-style: italic;
}
span.synopsis {
font-weight: bold;
margin-top: 0.5em;
display: block;
}
span.definition {
font-weight: bold;
display: block;
}
.codeblock {
margin-left: 1.2em;
line-height: 127%;
}
.outputblock {
margin-left: 1.2em;
line-height: 127%;
}
div.itemdecl {
margin-top: 2ex;
}
code.itemdeclcode {
white-space: pre;
display: block;
}
span.textsuperscript {
vertical-align: super;
font-size: smaller;
line-height: 0;
}
.footnotenum { vertical-align: super; font-size: smaller; line-height: 0; }
.footnote {
font-size: small;
margin-left: 2em;
margin-right: 2em;
margin-top: 0.6em;
margin-bottom: 0.6em;
}
div.minipage {
display: inline-block;
margin-right: 3em;
}
div.numberedTable {
text-align: center;
margin: 2em;
}
div.figure {
text-align: center;
margin: 2em;
}
table {
border: 1px solid black;
border-collapse: collapse;
margin-left: auto;
margin-right: auto;
margin-top: 0.8em;
text-align: left;
hyphens: none; 
}
td, th {
padding-left: 1em;
padding-right: 1em;
vertical-align: top;
}
td.empty {
padding: 0px;
padding-left: 1px;
}
td.left {
text-align: left;
}
td.right {
text-align: right;
}
td.center {
text-align: center;
}
td.justify {
text-align: justify;
}
td.border {
border-left: 1px solid black;
}
tr.rowsep, td.cline {
border-top: 1px solid black;
}
tr.even, tr.odd {
border-bottom: 1px solid black;
}
tr.capsep {
border-top: 3px solid black;
border-top-style: double;
}
tr.header {
border-bottom: 3px solid black;
border-bottom-style: double;
}
th {
border-bottom: 1px solid black;
}
span.centry {
font-weight: bold;
}
div.table {
display: block;
margin-left: auto;
margin-right: auto;
text-align: center;
width: 90%;
}
span.indented {
display: block;
margin-left: 2em;
margin-bottom: 1em;
margin-top: 1em;
}
ol.enumeratea { list-style-type: none; background: inherit; }
ol.enumerate { list-style-type: none; background: inherit; }

code.sourceCode > span { display: inline; }
</style>
  <link href="data:image/x-icon;base64,AAABAAIAEBAAAAEAIABoBAAAJgAAACAgAAABACAAqBAAAI4EAAAoAAAAEAAAACAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAVoJEAN6CRADegkQAWIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wCCRAAAgkQAAIJEAACCRAAsgkQAvoJEAP+CRAD/gkQA/4JEAP+CRADAgkQALoJEAACCRAAAgkQAAP///wD///8AgkQAAIJEABSCRACSgkQA/IJEAP99PQD/dzMA/3czAP99PQD/gkQA/4JEAPyCRACUgkQAFIJEAAD///8A////AHw+AFiBQwDqgkQA/4BBAP9/PxP/uZd6/9rJtf/bybX/upd7/39AFP+AQQD/gkQA/4FDAOqAQgBc////AP///wDKklv4jlEa/3o7AP+PWC//8+3o///////////////////////z7un/kFox/35AAP+GRwD/mVYA+v///wD///8A0Zpk+NmibP+0d0T/8evj///////+/fv/1sKz/9bCs//9/fr//////+/m2/+NRwL/nloA/5xYAPj///8A////ANKaZPjRmGH/5cKh////////////k149/3UwAP91MQD/lmQ//86rhv+USg3/m1YA/5hSAP+bVgD4////AP///wDSmmT4zpJY/+/bx///////8+TV/8mLT/+TVx//gkIA/5lVAP+VTAD/x6B//7aEVv/JpH7/s39J+P///wD///8A0ppk+M6SWP/u2sf///////Pj1f/Nj1T/2KFs/8mOUv+eWhD/lEsA/8aee/+0glT/x6F7/7J8Rvj///8A////ANKaZPjRmGH/48Cf///////+/v7/2qt//82PVP/OkFX/37KJ/86siv+USg7/mVQA/5hRAP+bVgD4////AP///wDSmmT40ppk/9CVXP/69O////////7+/v/x4M//8d/P//7+/f//////9u7n/6tnJf+XUgD/nFgA+P///wD///8A0ppk+NKaZP/RmWL/1qNy//r07///////////////////////+vXw/9akdP/Wnmn/y5FY/6JfFvj///8A////ANKaZFTSmmTo0ppk/9GYYv/Ql1//5cWm//Hg0P/x4ND/5cWm/9GXYP/RmGH/0ppk/9KaZOjVnmpY////AP///wDSmmQA0ppkEtKaZI7SmmT60ppk/9CWX//OkVb/zpFW/9CWX//SmmT/0ppk/NKaZJDSmmQS0ppkAP///wD///8A0ppkANKaZADSmmQA0ppkKtKaZLrSmmT/0ppk/9KaZP/SmmT/0ppkvNKaZCrSmmQA0ppkANKaZAD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkUtKaZNzSmmTc0ppkVNKaZADSmmQA0ppkANKaZADSmmQA////AP5/AAD4HwAA4AcAAMADAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAMADAADgBwAA+B8AAP5/AAAoAAAAIAAAAEAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAyCRACMgkQA6oJEAOqCRACQgkQAEIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRABigkQA5oJEAP+CRAD/gkQA/4JEAP+CRADqgkQAZoJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAA4gkQAwoJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQAxIJEADyCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAP///wD///8A////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAWgkQAmIJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAJyCRAAYgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAdIJEAPCCRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAPSCRAB4gkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQASoJEANKCRAD/gkQA/4JEAP+CRAD/g0YA/39AAP9zLgD/bSQA/2shAP9rIQD/bSQA/3MuAP9/PwD/g0YA/4JEAP+CRAD/gkQA/4JEAP+CRADUgkQAToJEAACCRAAAgkQAAP///wD///8A////AP///wB+PwAAgkUAIoJEAKiCRAD/gkQA/4JEAP+CRAD/hEcA/4BBAP9sIwD/dTAA/5RfKv+viF7/vp56/76ee/+wiF7/lWAr/3YxAP9sIwD/f0AA/4RHAP+CRAD/gkQA/4JEAP+CRAD/gkQArIJEACaBQwAA////AP///wD///8A////AIBCAEBzNAD6f0EA/4NFAP+CRAD/gkQA/4VIAP92MwD/bSUA/6N1Tv/ezsL/////////////////////////////////38/D/6V3Uv9uJgD/dTEA/4VJAP+CRAD/gkQA/4JEAP+BQwD/fUAA/4FDAEj///8A////AP///wD///8AzJRd5qBlKf91NgD/dDUA/4JEAP+FSQD/cy4A/3YyAP/PuKP//////////////////////////////////////////////////////9K7qP94NQD/ciwA/4VJAP+CRAD/fkEA/35BAP+LSwD/mlYA6v///wD///8A////AP///wDdpnL/4qx3/8KJUv+PUhf/cTMA/3AsAP90LgD/4dK+/////////////////////////////////////////////////////////////////+TYxf91MAD/dTIA/31CAP+GRwD/llQA/6FcAP+gWwD8////AP///wD///8A////ANGZY/LSm2X/4ap3/92mcP+wdT3/byQA/8mwj////////////////////////////////////////////////////////////////////////////+LYxv9zLgP/jUoA/59bAP+hXAD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/RmWL/1p9q/9ubXv/XqXj////////////////////////////7+fD/vZyG/6BxS/+gcUr/vJuE//r37f//////////////////////3MOr/5dQBf+dVQD/nVkA/5xYAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmWP/yohJ//jo2P//////////////////////4NTG/4JDFf9lGAD/bSQA/20kAP9kGAD/fz8S/+Xb0f//////5NG9/6txN/+LOgD/m1QA/51aAP+cWAD/m1cA/5xYAP+cWADy////AP///wD///8A////ANKaZPLSmmT/0ppk/8+TWf/Unmv//v37//////////////////////+TWRr/VwsA/35AAP+ERgD/g0UA/4JGAP9lHgD/kFga/8KXX/+TRwD/jT4A/49CAP+VTQD/n10A/5xYAP+OQQD/lk4A/55cAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/y4tO/92yiP//////////////////////8NnE/8eCQP+rcTT/ez0A/3IyAP98PgD/gEMA/5FSAP+USwD/jj8A/5lUAP+JNwD/yqV2/694Mf+HNQD/jkAA/82rf/+laBj/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/LiUr/4byY///////////////////////gupX/0I5P/+Wuev/Lklz/l1sj/308AP+QSwD/ol0A/59aAP+aVQD/k0oA/8yoh///////+fXv/6pwO//Lp3v///////Pr4f+oay7y////AP///wD///8A////ANKaZPLSmmT/0ppk/8uJSv/hvJj//////////////////////+G7l//Jhkb/0ppk/96nc//fqXX/x4xO/6dkFP+QSQD/llEA/5xXAP+USgD/yaOA///////38uv/qG05/8ijdv//////8efb/6ZpLPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/zIxO/9yxh///////////////////////7dbA/8iEQf/Sm2X/0Zlj/9ScZv/eqHf/2KJv/7yAQf+XTgD/iToA/5lSAP+JNgD/yKFv/611LP+HNQD/jT8A/8qmeP+kZRT/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/Pk1n/1J5q//78+//////////////////+/fv/1aFv/8iEQv/Tm2b/0ppl/9GZY//Wn2z/1pZc/9eldf/Bl2b/kUcA/4w9AP+OQAD/lUwA/59eAP+cWQD/jT8A/5ZOAP+eXADy////AP///wD///8A////ANKaZPLSmmT/0ppk/9KZY//KiEn/8d/P///////////////////////47+f/05tm/8iCP//KiEj/yohJ/8eCP//RmGH//vfy///////n1sP/rXQ7/4k4AP+TTAD/nVoA/5xYAP+cVwD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/0ptl/8uLTf/aq37////////////////////////////+/fz/6c2y/961jv/etY7/6Myx//78+v//////////////////////3MWv/5xXD/+ORAD/mFQA/51ZAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmmT/0ppk/8mFRP/s1b//////////////////////////////////////////////////////////////////////////////+PD/0JFU/7NzMv+WUQD/kUsA/5tXAP+dWQDy////AP///wD///8A////ANKaZP/SmmT/0ppk/9KaZP/Sm2X/z5NZ/8yMT//z5NX/////////////////////////////////////////////////////////////////9Ofa/8yNUP/UmGH/36p5/8yTWv+qaSD/kksA/5ROAPz///8A////AP///wD///8A0ppk5NKaZP/SmmT/0ppk/9KaZP/TnGf/zY9T/82OUv/t1sD//////////////////////////////////////////////////////+7Yw//OkFX/zI5R/9OcZ//SmmP/26V0/9ymdf/BhUf/ol8R6P///wD///8A////AP///wDSmmQ80ppk9tKaZP/SmmT/0ppk/9KaZP/TnGj/zpFW/8qJSv/dson/8uHS//////////////////////////////////Lj0//etIv/y4lL/86QVf/TnGj/0ppk/9KaZP/RmWP/05xn/9ymdfjUnWdC////AP///wD///8A////ANKaZADSmmQc0ppkotKaZP/SmmT/0ppk/9KaZP/Tm2b/0Zli/8qJSf/NjlH/16Z3/+G8mP/myKr/5siq/+G8mP/Xp3f/zY5S/8qISf/RmGH/05tm/9KaZP/SmmT/0ppk/9KaZP/SmmSm0pljINWdaQD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkQtKaZMrSmmT/0ppk/9KaZP/SmmT/0ptl/9GYYf/Nj1P/y4lL/8qISP/KiEj/y4lK/82PU//RmGH/0ptl/9KaZP/SmmT/0ppk/9KaZP/SmmTO0ppkRtKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZGzSmmTu0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmTw0ppkcNKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZBLSmmSQ0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppklNKaZBTSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQy0ppkutKaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppkvtKaZDbSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkXNKaZODSmmT/0ppk/9KaZP/SmmT/0ppk5NKaZGDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkBtKaZIbSmmTo0ppk6tKaZIrSmmQK0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP/8P///+B///+AH//+AAf//AAD//AAAP/AAAA/gAAAHwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA+AAAAfwAAAP/AAAP/8AAP//gAH//+AH///4H////D//" rel="icon" />
  
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="wrapper">
<header id="title-block-header">
<h1 class="title" style="text-align:center">Iterating on
<code class="sourceCode cpp">parallel_scheduler</code></h1>
<table style="border:none;float:right">
  <tr>
    <td>Document #:</td>
    <td>P3804R0</td>
  </tr>
  <tr>
    <td>Date:</td>
    <td>2025-09-03</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Project:</td>
    <td>Programming Language C++</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Audience:</td>
    <td>
      SG1, LEWG<br>
    </td>
  </tr>
  <tr>
    <td style="vertical-align:top">Reply-to:</td>
    <td>
      Lucian Radu Teodorescu (Garmin)<br>&lt;<a href="mailto:lucteo@lucteo.ro" class="email">lucteo@lucteo.ro</a>&gt;<br>
      Ruslan Arutyunyan (Intel)<br>&lt;<a href="mailto:ruslan.arutyunyan@intel.com" class="email">ruslan.arutyunyan@intel.com</a>&gt;<br>
    </td>
  </tr>
</table>
</header>
<div style="clear:both">
<div id="TOC" role="doc-toc">
<h1 id="toctitle">Contents</h1>
<ul>
<li><a href="#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction<span></span></a></li>
<li><a href="#discussions" id="toc-discussions"><span class="toc-section-number">2</span> Discussions<span></span></a>
<ul>
<li><a href="#receiver_proxytry_query-could-possibly-be-const-qualified" id="toc-receiver_proxytry_query-could-possibly-be-const-qualified"><span class="toc-section-number">2.1</span> <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
could possibly be const-qualified<span></span></a></li>
<li><a href="#receiver_proxy-does-not-need-a-virtual-destructor" id="toc-receiver_proxy-does-not-need-a-virtual-destructor"><span class="toc-section-number">2.2</span>
<code class="sourceCode cpp">receiver_proxy</code> does not need a
virtual destructor<span></span></a></li>
<li><a href="#receiver_proxytry_query-requires-inplace_stop_token-and-doesnt-accept-an-arbitrary-stop-token" id="toc-receiver_proxytry_query-requires-inplace_stop_token-and-doesnt-accept-an-arbitrary-stop-token"><span class="toc-section-number">2.3</span> <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
requires <code class="sourceCode cpp">inplace_stop_token</code> and
doesn’t accept an arbitrary stop token<span></span></a></li>
<li><a href="#the-list-of-properties-supported-by-receiver_proxytry_query-is-implementation-defined" id="toc-the-list-of-properties-supported-by-receiver_proxytry_query-is-implementation-defined"><span class="toc-section-number">2.4</span> The list of properties supported
by <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
is implementation-defined<span></span></a></li>
<li><a href="#receiver_proxytry_query-currently-requires-the-list-of-supported-queries-to-be-defined" id="toc-receiver_proxytry_query-currently-requires-the-list-of-supported-queries-to-be-defined"><span class="toc-section-number">2.5</span> <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
currently requires the list of supported queries to be
defined<span></span></a></li>
<li><a href="#system_context_replaceability-is-not-a-good-name-to-use-for-the-namespace-in-which-the-replaceability-apis-lie" id="toc-system_context_replaceability-is-not-a-good-name-to-use-for-the-namespace-in-which-the-replaceability-apis-lie"><span class="toc-section-number">2.6</span>
<code class="sourceCode cpp">system_context_replaceability</code> is not
a good name to use for the namespace in which the replaceability APIs
lie<span></span></a></li>
<li><a href="#the-wording-around-a-customizations-of-bulk_unchunkedbulk_chunked-for-parallel_scheduler-isnt-precise-enough" id="toc-the-wording-around-a-customizations-of-bulk_unchunkedbulk_chunked-for-parallel_scheduler-isnt-precise-enough"><span class="toc-section-number">2.7</span> The wording around a
customizations of
<code class="sourceCode cpp">bulk_unchunked</code>/<code class="sourceCode cpp">bulk_chunked</code>
for <code class="sourceCode cpp">parallel_scheduler</code> isn’t precise
enough<span></span></a></li>
</ul></li>
<li><a href="#proposed-wording" id="toc-proposed-wording"><span class="toc-section-number">3</span> Proposed
wording<span></span></a></li>
<li><a href="#acknowledgments" id="toc-acknowledgments"><span class="toc-section-number">4</span>
Acknowledgments<span></span></a></li>
<li><a href="#bibliography" id="toc-bibliography"><span class="toc-section-number">5</span> References<span></span></a></li>
</ul>
</div>
<style>
@media screen {
    #TOC {
        position: fixed;
        width: min(25%, 30em);
        height: 100%;
        left: 0;
        top: 0;
        overflow-y: scroll;
        padding-left: 1em;
        padding-right: 1em;
        text-align: left;
        a {
            font-size: 100%;
        }
    }
    body {
        padding-left: min(26%, 32em);
    }
}
</style>
<h1 class="unnumbered unlisted" id="abstract">Abstract<a href="#abstract" class="self-link"></a></h1>
<p>Although <code class="sourceCode cpp">parallel_scheduler</code> <span class="citation" data-cites="P2079R10">[<a href="https://wg21.link/p2079r10" role="doc-biblioref">P2079R10</a>]</span> had a long time in the baking,
getting it adopted in Sofia 2025 still left the impression that some of
the fine details were not sufficiently discussed. This paper proposes to
iterate over some of these aspects, aiming at getting the best possible
outcome from <code class="sourceCode cpp">parallel_scheduler</code>.</p>
<h1 data-number="1" id="introduction"><span class="header-section-number">1</span> Introduction<a href="#introduction" class="self-link"></a></h1>
<p>This paper tries to address the following concerns:</p>
<ul>
<li>Minor design tweaks:
<ol type="1">
<li><code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
could possibly be const-qualified.</li>
<li><code class="sourceCode cpp">receiver_proxy</code> does not need a
virtual destructor as the object is never destroyed
polymorphically.</li>
<li><code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
requires <code class="sourceCode cpp">inplace_stop_token</code> and
doesn’t accept an arbitrary stop token.</li>
<li>The list of properties supported by <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
is implementation-defined.</li>
</ol></li>
<li>Design concerns with larger impact:
<ol start="5" type="1">
<li><code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
currently requires the list of supported queries to be defined.</li>
</ol></li>
<li>Naming:
<ol start="6" type="1">
<li><code class="sourceCode cpp">system_context_replaceability</code> is
not a good name to use for the namespace in which the replaceability
APIs lie.</li>
</ol></li>
<li>Wording:
<ol start="7" type="1">
<li>The wording around a customizations of
<code class="sourceCode cpp">bulk_unchunked</code>/<code class="sourceCode cpp">bulk_chunked</code>
for <code class="sourceCode cpp">parallel_scheduler</code> isn’t precise
enough.</li>
</ol></li>
</ul>
<h1 data-number="2" id="discussions"><span class="header-section-number">2</span> Discussions<a href="#discussions" class="self-link"></a></h1>
<h2 data-number="2.1" id="receiver_proxytry_query-could-possibly-be-const-qualified"><span class="header-section-number">2.1</span> <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
could possibly be const-qualified<a href="#receiver_proxytry_query-could-possibly-be-const-qualified" class="self-link"></a></h2>
<p>Currently the specification defines
<code class="sourceCode cpp">try_query</code> as:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">class</span> P, <em>class-type</em> Query<span class="op">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>optional<span class="op">&lt;</span>P<span class="op">&gt;</span> try_query<span class="op">(</span>Query q<span class="op">)</span> <span class="kw">noexcept</span>;</span></code></pre></div>
<p>This is not marked as
<code class="sourceCode cpp"><span class="kw">const</span></code>, but
there is no good reason why we couldn’t mark it as such. This paper
proposes a change to mark this function as
<code class="sourceCode cpp"><span class="kw">const</span></code>.</p>
<h2 data-number="2.2" id="receiver_proxy-does-not-need-a-virtual-destructor"><span class="header-section-number">2.2</span>
<code class="sourceCode cpp">receiver_proxy</code> does not need a
virtual destructor<a href="#receiver_proxy-does-not-need-a-virtual-destructor" class="self-link"></a></h2>
<p>The code that destroys instances of
<code class="sourceCode cpp">receiver_proxy</code> knows the actual type
of the object, so the objects of type
<code class="sourceCode cpp">receiver_proxy</code> don’t need to be
polymorphically destroyed. This paper proposes to remove the virtual
destructor.</p>
<h2 data-number="2.3" id="receiver_proxytry_query-requires-inplace_stop_token-and-doesnt-accept-an-arbitrary-stop-token"><span class="header-section-number">2.3</span> <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
requires <code class="sourceCode cpp">inplace_stop_token</code> and
doesn’t accept an arbitrary stop token<a href="#receiver_proxytry_query-requires-inplace_stop_token-and-doesnt-accept-an-arbitrary-stop-token" class="self-link"></a></h2>
<p>The specification of <code class="sourceCode cpp">parallel_scheduler<span class="op">::</span>try_query</code>
<span class="citation" data-cites="P2079R10">[<a href="https://wg21.link/p2079r10" role="doc-biblioref">P2079R10</a>]</span> is too restrictive with
respect to querying stop tokens. The wording states
([exec.sysctxrepl.query]):</p>
<hr />
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> P, <em>class-type</em> Query<span class="op">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>optional<span class="op">&lt;</span>P<span class="op">&gt;</span> try_query<span class="op">(</span>Query q<span class="op">)</span> <span class="kw">noexcept</span>;</span></code></pre></div>
<p><span class="marginalizedparent"><a class="marginalized">5</a></span>
<em>Mandates</em>: <code class="sourceCode cpp">P</code> is a
cv-unqualified non-array object type.</p>
<p><span class="marginalizedparent"><a class="marginalized">6</a></span>
<em>Returns</em>: Let <code class="sourceCode cpp">env</code> be the
environment of the receiver represented by <code class="sourceCode cpp"><span class="op">*</span><span class="kw">this</span></code>.
If:</p>
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(6.1)</a></span>
<code class="sourceCode cpp">Query</code> is not a member of an
implementation-defined set of supported queries; or</li>
<li><span class="marginalizedparent"><a class="marginalized">(6.2)</a></span>
<code class="sourceCode cpp">P</code> is not a member of an
implementation-defined set of supported result types for
<code class="sourceCode cpp">Query</code>; or</li>
<li><span class="marginalizedparent"><a class="marginalized">(6.3)</a></span> the
expression <code class="sourceCode cpp">q<span class="op">(</span>env<span class="op">)</span></code>
is not well-formed or does not have type
<em><code class="sourceCode cpp">cv</code></em>
<code class="sourceCode cpp">P</code>,</li>
</ul>
<p>then returns <code class="sourceCode cpp">nullopt</code>. Otherwise,
returns <code class="sourceCode cpp">q<span class="op">(</span>env<span class="op">)</span></code>.</p>
<p><span class="marginalizedparent"><a class="marginalized">7</a></span>
<em>Remarks</em>: <code class="sourceCode cpp">get_stop_token_t</code>
is in the implementation-defined set of supported queries, and
<code class="sourceCode cpp">inplace_stop_token</code> is a member of
the implementation-defined set of supported result types for
<code class="sourceCode cpp">get_stop_token_t</code>.</p>
<hr />
<p>This implies that, if <code class="sourceCode cpp">q<span class="op">(</span>get_stop_token_t<span class="op">)</span></code>
returns <code class="sourceCode cpp">std<span class="op">::</span>stop_token</code>,
then <code class="sourceCode cpp">try_query<span class="op">(</span>get_stop_token_t<span class="op">)</span></code>
returns <code class="sourceCode cpp">nullopt</code>. More generally, if
<code class="sourceCode cpp">q<span class="op">(</span>get_stop_token_t<span class="op">)</span></code>
returns a type that models
<code class="sourceCode cpp">stoppable_token</code>, other than
<code class="sourceCode cpp">inplace_stop_token</code>, then <code class="sourceCode cpp">try_query<span class="op">(</span>get_stop_token_t<span class="op">)</span></code>
returns <code class="sourceCode cpp">nullopt</code>. There is no
portable way for the backend to check the stop token of the
receiver.</p>
<p>This paper proposes an extension of the above schema to allow the
possibility of using stop tokens other than
<code class="sourceCode cpp">inplace_stop_token</code>. If <code class="sourceCode cpp">q<span class="op">(</span>env<span class="op">)</span></code>
has the type <em><code class="sourceCode cpp">cv</code></em>
<code class="sourceCode cpp">T</code>, and there is an implementation
defined mapping from objects of type
<code class="sourceCode cpp">T</code> to objects of type
<code class="sourceCode cpp">P</code>, then <code class="sourceCode cpp">try_query<span class="op">&lt;</span>P<span class="op">&gt;(</span>q<span class="op">)</span></code>
is allowed to return non-null objects.</p>
<p>We recommend the implementations to support such mappings between any
stop token to <code class="sourceCode cpp">inplace_stop_token</code>.
This would essentially make the frontend register a stop callback to the
token from the environment and transform the stop request into a stop
request to a temporary
<code class="sourceCode cpp">inplace_stop_token</code>.</p>
<p>Please note that this mechanism is useful for other property types,
not just stop tokens.</p>
<p>We also considered an alternative design in which we add a
<code class="sourceCode cpp">request_stop</code> member-function to
<code class="sourceCode cpp">parallel_scheduler_backend</code>. This
method would increase the API surface, and render the property-querying
mechanism useless. We considered this solution to be less flexible, as,
on the long run, it would lead to an overly-complex API for
replaceability.</p>
<h2 data-number="2.4" id="the-list-of-properties-supported-by-receiver_proxytry_query-is-implementation-defined"><span class="header-section-number">2.4</span> The list of properties
supported by <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
is implementation-defined<a href="#the-list-of-properties-supported-by-receiver_proxytry_query-is-implementation-defined" class="self-link"></a></h2>
<p>When <span class="citation" data-cites="P2079R10">[<a href="https://wg21.link/p2079r10" role="doc-biblioref">P2079R10</a>]</span> defines the possibilities for
the backend to query the properties of the final receiver it specifies
that the list of properties (both property types and query types) are
implementation-defined. Instead, the proposal could have defined a fixed
list of properties to be supported when replacing the backend.</p>
<p>That seems to be a limiting factor as we would want to support two
use-cases:</p>
<ol type="1">
<li>Implementers might want to add additional properties to be
queried</li>
<li>Implementers might not want to implement all the properties</li>
</ol>
<p>A good example for the first case is a vendor adding support for
thread priorities. With the existing proposal, this can be done in a
compliant manner.</p>
<p>The second case involves implementors opting out of certain
properties. Let us assume that we standardize a mechanism to query
thread priorities from the receiver. But, this may not make much
difference on certain platforms, thus the implementors shall be able to
opt out of supporting this query. Supporting a query typically has a
small cost associated with it, so it makes sense to allow opting out of
this cost if it doesn’t make sense for the targeted platform.</p>
<p>Even with stop token property that is specified by <span class="citation" data-cites="P2079R10">[<a href="https://wg21.link/p2079r10" role="doc-biblioref">P2079R10</a>]</span>, it may not always make sense
to support cancellation on the backend. The frontend can implement
cancellation without passing this information to the backend.</p>
<p>Thus, the authors believe that the current option of making the list
of properties (and query types) is the right choice for the users and no
changes are needed here.</p>
<h2 data-number="2.5" id="receiver_proxytry_query-currently-requires-the-list-of-supported-queries-to-be-defined"><span class="header-section-number">2.5</span> <code class="sourceCode cpp">receiver_proxy<span class="op">::</span>try_query</code>
currently requires the list of supported queries to be defined<a href="#receiver_proxytry_query-currently-requires-the-list-of-supported-queries-to-be-defined" class="self-link"></a></h2>
<p>One workflow that some of C++ have is to have separate compilations
of their libraries. Two libraries, A and B can be compiled separately,
sometimes with different versions of the compiler, sometimes even with
different compilers (provided that the ABI match). This feature cannot
break this flow.</p>
<p>For practical reasons, we can consider the backend of
<code class="sourceCode cpp">parallel_scheduler</code> as yet another
library C that can be compiled separately from the rest of the program.
The backend may be compiled with different flag and with a different
compiler than the rest of the modules (again, if the ABI matches). That
is, there is a complete separation between the frontend (library
implementing <code class="sourceCode cpp">parallel_scheduler</code>) and
the backend (user provided implementation of
<code class="sourceCode cpp">parallel_scheduler_backend</code>).</p>
<p>This separation makes it impossible a completely extensible list of
properties that can be dynamically agreed between the frontend and the
backend. Let us walk the implications of this with two examples.</p>
<p>Let’s assume that frontend defines a new property
<code class="sourceCode cpp">friendliness</code>; maybe the program was
compiled with a newer version of the standard that defined this
property, while the backend is compiled with C++26. How would the
backend implementation use this new property if it doesn’t even know it
exists? It cannot.</p>
<p>Looking from the opposite direction, let’s now assume that the
backend is compiled with a newer version of the standard that knows
about the <code class="sourceCode cpp">firendliness</code> property, and
that the frontend is compiled with C++26 which doesn’t know about this
property. The backend can try to query on the existence of this
property, and we hope that the query needs to be actually fulfilled in
the frontend.</p>
<p>In this case, the discussion can be slightly more complicated. While
the frontend might not know about
<code class="sourceCode cpp">friendliness</code>, the environment in
which the sender created by
<code class="sourceCode cpp">parallel_scheduler</code> might now about
this (for example, the user code is built for a newer version of C++
than the standard library it uses). Looking at the versions, the triad
user code, <code class="sourceCode cpp">parallel_scheduler</code> and
backend looks like: new-old-new. While, theoretically we can solve the
problem making the query work between the frontend and the backend
(complicated, but we can), we need to solve the problem for the fronted
querying the environment for a property
<code class="sourceCode cpp">friendliness</code> that it does not know
about (e.g., the same problem as before).</p>
<p>The frontend can only query the environment by having some
compile-time knowledge. Thus, the list of properties that frontend
supports need to be known at compile-time. This aligns with the existing
design in which both the frontend and the backend need to know at
compile-time the list of properties that they support.</p>
<p>To put it in a different perspective, the querying mechanism for
senders/receivers is compile-time, and we cannot use it fully dynamic
over run-time resilience boundaries.</p>
<p>The authors don’t see any changes in this area that would benefit the
users.</p>
<h2 data-number="2.6" id="system_context_replaceability-is-not-a-good-name-to-use-for-the-namespace-in-which-the-replaceability-apis-lie"><span class="header-section-number">2.6</span>
<code class="sourceCode cpp">system_context_replaceability</code> is not
a good name to use for the namespace in which the replaceability APIs
lie<a href="#system_context_replaceability-is-not-a-good-name-to-use-for-the-namespace-in-which-the-replaceability-apis-lie" class="self-link"></a></h2>
<p>Previously, <code class="sourceCode cpp">parallel_scheduler</code>
was called <code class="sourceCode cpp">system_scheduler</code>, and was
part of <code class="sourceCode cpp">system_context</code>. In that
sense, the name
<code class="sourceCode cpp">system_context_replaceability</code> made
sense; it was the namespace in which we put things related to replacing
default implementation around
<code class="sourceCode cpp">system_context</code>. But now, we ended up
with a different name, so the question is whether
<code class="sourceCode cpp">system_context_replaceability</code> still
makes sense.</p>
<p>There are people who’s answer would be no. In that case, we might
rename the namespace to something like
<code class="sourceCode cpp">parallel_scheduler_replaceability</code>.</p>
<p>But, there are also arguments for keeping the current name. We also
envision having different types of schedulers. We were previously taking
about a <code class="sourceCode cpp">main_scheduler</code> to be used on
systems that have only one thread, or in which the main thread needs
special treatment. We also had brief discussions about the need of
<code class="sourceCode cpp">io_scheduler</code> (or
<code class="sourceCode cpp">elastic_parallel_scheduler</code>) and
<code class="sourceCode cpp">priority_scheduler</code> (to create
threads with different priorities).</p>
<p>There is a high chance that we would add new system-wide schedulers
in the future. But, if that is the case, and we want their backends to
be replaceable, should we create completely different namespaces for
them? Or should we reuse the abstractions that we already have?</p>
<p>Probably, a good answer would be that we want to reuse the same
namespace. In this context, the name
<code class="sourceCode cpp">system_context_replaceability</code> makes
sense. Especially since the work
<code class="sourceCode cpp">context</code> appears in the name, not the
word <code class="sourceCode cpp">scheduler</code>.</p>
<p>The authors don’t have a strong preference, and would like this to be
discussed in LEWG. The following table shows a few options:</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="header">
<th><div style="text-align:center">
<strong>Proposal</strong>
</div></th>
<th><div style="text-align:center">
<strong>Notes</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code class="sourceCode cpp">system_context_replaceability</code></td>
<td>Status quo. Allows replacing other backend in the future</td>
</tr>
<tr class="even">
<td><code class="sourceCode cpp">parallel_scheduler_replaceability</code></td>
<td>Better matches the new name</td>
</tr>
<tr class="odd">
<td><code class="sourceCode cpp">scheduler_replaceability</code></td>
<td>Variation</td>
</tr>
<tr class="even">
<td><code class="sourceCode cpp">scheduler_backend_replaceability</code></td>
<td>Variation</td>
</tr>
<tr class="odd">
<td><code class="sourceCode cpp">parallel_scheduler_backend_replaceability</code></td>
<td>Variation</td>
</tr>
</tbody>
</table>
<h2 data-number="2.7" id="the-wording-around-a-customizations-of-bulk_unchunkedbulk_chunked-for-parallel_scheduler-isnt-precise-enough"><span class="header-section-number">2.7</span> The wording around a
customizations of
<code class="sourceCode cpp">bulk_unchunked</code>/<code class="sourceCode cpp">bulk_chunked</code>
for <code class="sourceCode cpp">parallel_scheduler</code> isn’t precise
enough<a href="#the-wording-around-a-customizations-of-bulk_unchunkedbulk_chunked-for-parallel_scheduler-isnt-precise-enough" class="self-link"></a></h2>
<p>The wording in <span class="citation" data-cites="P2079R10">[<a href="https://wg21.link/p2079r10" role="doc-biblioref">P2079R10</a>]</span> mandated that we want
customizations for
<code class="sourceCode cpp">bulk_unchunked</code>/<code class="sourceCode cpp">bulk_chunked</code>,
but it did not describe the details. Actually, this discussion was
completely missing from the design section too. The proof of concept
implementation used the early customization mechanism, and part of the
authors assumed that was always the case, but the paper doesn’t mention
anything about it. This needs to be fixed.</p>
<p>There are two main methods in which we can customize the
<code class="sourceCode cpp">bulk</code> algorithms:</p>
<ul>
<li>early customization (based just on the previous sender, before
connecting the resulting sender to a receiver);</li>
<li>late customization (also taking into consideration the environment
of the receiver).</li>
</ul>
<!-- The following table shows a few examples and whether they would work with early or late customizations:

<table border="1">
<style>
    th {
        border-bottom: 3px double black; /* Double underline */
    }
</style>
<tr><th>Example</th><th>Early?</th><th>Late?</th><th>Notes</th></tr>

<tr>
<td>
```c++
task<void> example1() {
  co_await bulk(schedule(get_parallel_scheduler()), par, 1'000'000, func);
}
```
</td>
<td>yes</td><td>no</td><td>Scheduler is taken from previous sender.</td>
</tr>

<tr>
<td>
```c++
task<void, parallel_env> example2() {
  co_await bulk(just(), par, 1'000'000, func);
}
```
</td>
<td>no</td><td>yes</td><td>Taking the scheduler from the environment of the receiver.</td>
</tr>

<tr>
<td>
```c++
task<void, parallel_env> example3() {
  parallel_scheduler sched = co_await read_env(get_scheduler);
  co_await bulk(schedule(sched), par, 1'000'000, func);
}
```
</td>
<td>yes</td><td>yes</td><td>Allows early-customization; no extra `schedule` operation is actually executed.</td>
</tr>

<tr>
<td>
```c++
task<void, parallel_env> example4() {
  parallel_scheduler sched = co_await read_env(get_scheduler);
  sender auto prev = schedule(sched) | then(something);
  co_await bulk(std::move(prev), par, 1'000'000, func);
}
```
</td>
<td>yes</td><td>yes</td><td>Early customization works even if the previous sender isn't directly a `schedule`.</td>
</tr>

<tr>
<td>
```c++
task<void, parallel_env> example5() {
  parallel_scheduler sched = co_await read_env(get_scheduler);
  co_await bulk(pseudo_schedule(sched), par, 1'000'000, func);
}
```
</td>
<td>yes</td><td>yes</td><td>Early customizations with custom scheduling.</td>
</tr>

</table> -->
<p>The early customization depends only on the previous sender passed to
the <code class="sourceCode cpp">bulk</code> algorithms. If this has a
domain that is equal to the domain of
<code class="sourceCode cpp">parallel_scheduler</code> then early
customization kicks in. On the other hand, late customization also takes
into consideration the domain coming from the receiver’s
environment.</p>
<p>The <code class="sourceCode cpp">bulk</code> algorithms are not
expected to depend on the receiver’s environment, so making it late
customizable will be a surprise to the users. The user expects that
<code class="sourceCode cpp">bulk</code> is run on the scheduler of its
given predecessor.</p>
<p>If we implement early customization for
<code class="sourceCode cpp">bulk</code> algorithms, the following
example would not take advantage of parallel scheduler:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>task<span class="op">&lt;</span><span class="dt">void</span>, parallel_env<span class="op">&gt;</span> calls_serial_bulk<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">co_await</span> bulk<span class="op">(</span>just<span class="op">()</span>, par, <span class="dv">1&#39;000&#39;000</span>, func<span class="op">)</span>;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is fine, as it appears immediately to the user that
<code class="sourceCode cpp">parallel_scheduler</code> was not used in
<code class="sourceCode cpp">bulk</code>s invocation (even if
<code class="sourceCode cpp">parallel_scheduler</code> can be obtained
from the receiver’s environment). To ensure that the
<code class="sourceCode cpp">bulk</code> is run on
<code class="sourceCode cpp">parallel_scheduler</code>, the user can do
the following:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>task<span class="op">&lt;</span><span class="dt">void</span>, parallel_env<span class="op">&gt;</span> calls_parallel_bulk<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  parallel_scheduler sched <span class="op">=</span> <span class="kw">co_await</span> read_env<span class="op">(</span>get_scheduler<span class="op">)</span>;</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">co_await</span> bulk<span class="op">(</span>schedule<span class="op">(</span>sched<span class="op">)</span>, par, <span class="dv">1&#39;000&#39;000</span>, func<span class="op">)</span>;</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This makes it explicit that we want to use the scheduler from the
environment. It is typically a good idea to demand the user to be
explicit in such cases, and avoid guessing.</p>
<p>If the user somehow gets this wrong, the performance difference
between running the <code class="sourceCode cpp">bulk</code> algorithm
on <code class="sourceCode cpp">parallel_scheduler</code> and running it
serially should be immediately noticeable, and the user can fix the
mistake. But, if we wanted to have late customization, and the user gets
it wrong, jumping from one execution agent to another might not be
immediately noticeable, making the mistake harder to find.</p>
<p>In addition of specifying how the customization needs to be
implemented, the wording also misses specification on how the execution
policies passed to <code class="sourceCode cpp">bulk</code> algorithms
are handled.</p>
<p>This paper advocates for using early customization of
<code class="sourceCode cpp">bulk</code> algorithms for
<code class="sourceCode cpp">parallel_scheduler</code>.</p>
<h1 data-number="3" id="proposed-wording"><span class="header-section-number">3</span> Proposed wording<a href="#proposed-wording" class="self-link"></a></h1>
<p>In section Parallel scheduler [exec.par.scheduler], apply the
following changes:</p>
<div class="rm" style="color: #bf0303">
<p><span class="marginalizedparent"><a class="marginalized">7</a></span>
A <em>bulk chunked proxy for
<code class="sourceCode default">rcvr</code> with callable
<code class="sourceCode default">f</code> and arguments
<code class="sourceCode default">args</code></em> is a proxy
<code class="sourceCode default">r</code> for
<code class="sourceCode default">rcvr</code> with base <code class="sourceCode default">system_context_replaceability::bulk_item_receiver_proxy</code>
such that<code class="sourceCode default">r.execute(i, j)</code> for
indices <code class="sourceCode default">i</code> and
<code class="sourceCode default">j</code> has effects equivalent to
<code class="sourceCode default">f(i, j, args...)</code>.</p>
<p><span class="marginalizedparent"><a class="marginalized">8</a></span>
A <em>bulk unchunked proxy for
<code class="sourceCode default">rcvr</code> with callable
<code class="sourceCode default">f</code> and arguments
<code class="sourceCode default">args</code></em> is a proxy
<code class="sourceCode default">r</code> for
<code class="sourceCode default">rcvr</code> with base <code class="sourceCode default">system_context_replaceability::bulk_item_receiver_proxy</code>
such that <code class="sourceCode default">r.execute(i, i+1)</code> for
index <code class="sourceCode default">i</code> has effects equivalent
to <code class="sourceCode default">f(i, args...)</code>.</p>
</div>
<p><span class="marginalizedparent"><a class="marginalized">9</a></span>
Let <code class="sourceCode cpp">b</code> be
<i><code class="sourceCode cpp">BACKEND<span class="op">-</span>OF</code></i><code class="sourceCode cpp"><span class="op">(</span>sch<span class="op">)</span></code>,
let <code class="sourceCode cpp">sndr</code> be the object returned by
<code class="sourceCode cpp">schedule<span class="op">(</span>sch<span class="op">)</span></code>,
and let <code class="sourceCode cpp">rcvr</code> be a receiver. If
<code class="sourceCode cpp">rcvr</code> is connected to
<code class="sourceCode cpp">sndr</code> and the resulting operation
state is started, then: - If <code class="sourceCode cpp">sndr</code>
completes successfully, then <code class="sourceCode cpp">b<span class="op">.</span>schedule<span class="op">(</span>r, s<span class="op">)</span></code>
is called, where: - <code class="sourceCode cpp">r</code> is a proxy for
<code class="sourceCode cpp">rcvr</code> with base <code class="sourceCode cpp">system_context_replaceability<span class="op">::</span>receiver_proxy</code>;
and - <code class="sourceCode cpp">s</code> is a preallocated backend
storage for <code class="sourceCode cpp">r</code>. - All other
completion operations are forwarded unchanged.</p>
<div class="rm" style="color: #bf0303">
<p><span class="marginalizedparent"><a class="marginalized">10</a></span>
<code class="sourceCode default">parallel_scheduler</code> provides a
customized implementation of
<code class="sourceCode default">bulk_chunked</code> algorithm
(<span>33.9.12.11
<a href="https://wg21.link/exec.bulk">[exec.bulk]</a></span>). If a
receiver <code class="sourceCode default">rcvr</code> is connected to
the sender returned by <code class="sourceCode default">bulk_chunked(sndr, pol, shape, f)</code> and
the resulting operation state is started, then:</p>
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(10.1)</a></span> If
<code class="sourceCode default">sndr</code> completes with values
<code class="sourceCode default">vals</code>, let
<code class="sourceCode default">args</code> be a pack of lvalue
subexpressions designating <code class="sourceCode default">vals</code>,
then <code class="sourceCode default">b.schedule_bulk_chunked(shape, r, s)</code>
is called, where:
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(10.1.1)</a></span>
<code class="sourceCode default">r</code> is a bulk chunked proxy for
<code class="sourceCode default">rcvr</code> with callable
<code class="sourceCode default">f</code> and arguments
<code class="sourceCode default">args</code>; and</li>
<li><span class="marginalizedparent"><a class="marginalized">(10.1.2)</a></span>
<code class="sourceCode default">s</code> is a preallocated backend
storage for <code class="sourceCode default">r</code>.</li>
</ul></li>
<li><span class="marginalizedparent"><a class="marginalized">(10.2)</a></span> All
other completion operations are forwarded unchanged.</li>
</ul>
<p><span class="note"><span>[ <em>Note:</em> </span>Customizing the
behavior of <code class="sourceCode default">bulk_chunked</code> affects
the default implementation of
<code class="sourceCode default">bulk</code><span> — <em>end note</em>
]</span></span>.</p>
<p><span class="marginalizedparent"><a class="marginalized">11</a></span>
<code class="sourceCode default">parallel_scheduler</code> provides a
customized implementation of
<code class="sourceCode default">bulk_unchunked</code> algorithm
[exec.bulk]. If a receiver <code class="sourceCode default">rcvr</code>
is connected to the sender returned by <code class="sourceCode default">bulk_unchunked(sndr, pol, shape, f)</code>
and the resulting operation state is started, then:</p>
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(11.1)</a></span> If
<code class="sourceCode default">sndr</code> completes with values
<code class="sourceCode default">vals</code>, let
<code class="sourceCode default">args</code> be a pack of lvalue
subexpressions designating <code class="sourceCode default">vals</code>,
then <code class="sourceCode default">b.schedule_bulk_unchunked(shape, r, s)</code>
is called, where:
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(11.1.1)</a></span>
<code class="sourceCode default">r</code> is a bulk unchunked proxy for
<code class="sourceCode default">rcvr</code> with callable
<code class="sourceCode default">f</code> and arguments
<code class="sourceCode default">args</code>; and</li>
<li><span class="marginalizedparent"><a class="marginalized">(11.1.2)</a></span>
<code class="sourceCode default">s</code> is a preallocated backend
storage for <code class="sourceCode default">r</code>.</li>
</ul></li>
<li><span class="marginalizedparent"><a class="marginalized">(11.2)</a></span> All
other completion operations are forwarded unchanged.</li>
</ul>

</div>
<div class="add" style="color: #006e28">
<p><span class="marginalizedparent"><a class="marginalized">?</a></span>
Let
<em><code class="sourceCode default">TAG-OF</code></em><code class="sourceCode default">(sndr)</code>
be the tag type of sender <code class="sourceCode default">sndr</code>.
If
<em><code class="sourceCode default">TAG-OF</code></em><code class="sourceCode default">(sndr)</code>
is <code class="sourceCode default">bulk_chunked_t</code> or
<code class="sourceCode default">bulk_unchunked_t</code>, let
<em><code class="sourceCode default">POLICY-OF</code></em><code class="sourceCode default">(sndr)</code>
be the execution policy used to construct the sender and let
<em><code class="sourceCode default">SHAPE-OF</code></em><code class="sourceCode default">(sndr)</code>
be the shape used to construct the sender. Also, let
<em><code class="sourceCode default">PARALLELIZABLE</code></em><code class="sourceCode default">(pol)</code>
for an execution policy <code class="sourceCode default">pol</code> be
<code class="sourceCode default">true</code> if
<code class="sourceCode default">pol</code> is
<code class="sourceCode default">par</code> or
<code class="sourceCode default">par_unseq</code>, and
<code class="sourceCode default">false</code> otherwise.</p>
<p><span class="marginalizedparent"><a class="marginalized">10</a></span> The
expression <code class="sourceCode default">get_domain(sch)</code>
returns an expression of exposition-only type
<em><code class="sourceCode default">parallel-scheduler-domain</code></em>,
that is equivalent with:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode default cpp"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>struct <em>parallel-scheduler-domain</em> {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    template&lt;sender Sndr, queryable... Env&gt;</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        requires (sizeof...(Env) &lt;= 1)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      static constexpr sender decltype(auto) transform_sender(Sndr&amp;&amp; sndr, const Env&amp;... env)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        noexcept;</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>};</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode default default"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>template&lt;sender Sndr, queryable... Env&gt;</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  requires (sizeof...(Env) &lt;= 1)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>constexpr sender decltype(auto) <em>parallel-scheduler-domain</em>::transform_sender(Sndr&amp;&amp; sndr, const Env&amp;... env)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  noexcept;</span></code></pre></div>
<ul>
<li><span class="marginalizedparent"><a class="marginalized">11</a></span>
<em>Returns</em>:
<ul>
<li><p><span class="marginalizedparent"><a class="marginalized">(11.1)</a></span>
<code class="sourceCode default">sndr</code>, if <code class="sourceCode default">same_as&lt;auto(get_completion_scheduler&lt;set_value_t&gt;(get_env(sndr))), parallel_scheduler&gt;</code>
is <code class="sourceCode default">false</code> or if if
<em><code class="sourceCode default">TAG-OF</code></em><code class="sourceCode default">(sndr)</code>
is not <code class="sourceCode default">bulk_chunked_t</code> nor
<code class="sourceCode default">bulk_unchunked_t</code>.</p></li>
<li><p><span class="marginalizedparent"><a class="marginalized">(11.2)</a></span>
Otherwise, it returns a sender that, when a receiver
<code class="sourceCode default">rcvr</code> is connected to it, and the
resulting operation state is started, then:</p>
<ul>
<li><p><span class="marginalizedparent"><a class="marginalized">(11.2.1)</a></span>
If <code class="sourceCode default">sndr</code> completes with values
<code class="sourceCode default">vals</code>, let
<code class="sourceCode default">args</code> be a pack of lvalue
subexpressions designating <code class="sourceCode default">vals</code>,
let <code class="sourceCode default">parallelize</code> be <code class="sourceCode default"><em>PARALLELIZABLE</em>(<em>POLICY-OF</em>(sndr))</code>,
and let <code class="sourceCode default">shape</code> be
<code class="sourceCode default"><em>SHAPE-OF</em>(sndr)</code>,
then:</p>
<ul>
<li><p><span class="marginalizedparent"><a class="marginalized">(11.2.1.1)</a></span>
If
<em><code class="sourceCode default">TAG-OF</code></em><code class="sourceCode default">(sndr)</code>
is <code class="sourceCode default">bulk_chunked_t</code>, then <code class="sourceCode default">b.schedule_bulk_chunked(parallelize ? shape : 1, r, s)</code>
is called, where:</p>
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(11.2.1.1.1)</a></span>
<code class="sourceCode default">r</code> is a proxy for
<code class="sourceCode default">rcvr</code> with base <code class="sourceCode default">system_context_replaceability::bulk_item_receiver_proxy</code>
such that <code class="sourceCode default">r.execute(i, j)</code> for
indices <code class="sourceCode default">i</code> and
<code class="sourceCode default">j</code> has effects equivalent to
<code class="sourceCode default">f(i, j, args...)</code> if
<code class="sourceCode default">parallelize</code> is
<code class="sourceCode default">true</code> and
<code class="sourceCode default">f(0, shape, args...)</code> otherwise;
and</li>
<li><span class="marginalizedparent"><a class="marginalized">(11.2.1.1.2)</a></span>
<code class="sourceCode default">s</code> is a preallocated backend
storage for <code class="sourceCode default">r</code>.</li>
</ul></li>
<li><p><span class="marginalizedparent"><a class="marginalized">(11.2.1.2)</a></span>
If
<em><code class="sourceCode default">TAG-OF</code></em><code class="sourceCode default">(sndr)</code>
is <code class="sourceCode default">bulk_unchunked_t</code>, then <code class="sourceCode default">b.schedule_bulk_unchunked(parallelize ? shape : 1, r, s)</code>
is called, where:</p>
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(11.2.1.2.1)</a></span>
<code class="sourceCode default">r</code> is a proxy for
<code class="sourceCode default">rcvr</code> with base <code class="sourceCode default">system_context_replaceability::bulk_item_receiver_proxy</code>
such that <code class="sourceCode default">r.execute(i, i+1)</code> for
index <code class="sourceCode default">i</code> has effects equivalent
to <code class="sourceCode default">f(i, args...)</code> if
<code class="sourceCode default">parallelize</code> is
<code class="sourceCode default">true</code> and <code class="sourceCode default">for (decltype(shape) i=0; i&lt;shape; i++) { f(i, shape, args...) }</code>
otherwise; and</li>
<li><span class="marginalizedparent"><a class="marginalized">(11.2.1.2.2)</a></span>
<code class="sourceCode default">s</code> is a preallocated backend
storage for <code class="sourceCode default">r</code>.</li>
</ul></li>
</ul></li>
<li><p><span class="marginalizedparent"><a class="marginalized">(11.2.2)</a></span>
All other completion operations are forwarded unchanged.</p></li>
</ul></li>
</ul></li>
</ul>

</div>
<hr>
<p>In section
<code class="sourceCode cpp">query_parallel_scheduler_backend</code>
[exec.sysctxrepl.query], apply the following changes:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> std<span class="op">::</span>execution<span class="op">::</span>system_context_replaceability <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> receiver_proxy <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="rm" style="color: #bf0303"><del><span><code class="sourceCode default">virtual ~receiver_proxy() = default;</code></span></del></span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">protected</span><span class="op">:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">bool</span> <em>query-env</em><span class="op">(</span><em>unspecified</em><span class="op">)</span> <span class="kw">noexcept</span> <span class="op">=</span> <span class="dv">0</span>;   <span class="co">// exposition only</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">void</span> set_value<span class="op">()</span> <span class="kw">noexcept</span> <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">void</span> set_error<span class="op">(</span>exception_ptr<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">void</span> set_stopped<span class="op">()</span> <span class="kw">noexcept</span> <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span><span class="op">&lt;</span><span class="kw">class</span> P, <em>class-type</em> Query<span class="op">&gt;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      optional<span class="op">&lt;</span>P<span class="op">&gt;</span> try_query<span class="op">(</span>Query q<span class="op">)</span> <span class="add" style="color: #006e28"><ins><span><code class="sourceCode default">const</code></span></ins></span> <span class="kw">noexcept</span>;</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> bulk_item_receiver_proxy <span class="op">:</span> receiver_proxy <span class="op">{</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">virtual</span> <span class="dt">void</span> execute<span class="op">(</span><span class="dt">size_t</span>, <span class="dt">size_t</span><span class="op">)</span> <span class="kw">noexcept</span> <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><span class="marginalizedparent"><a class="marginalized">4</a></span>
<code class="sourceCode cpp">receiver_proxy</code> represents a receiver
that will be notified by the implementations of
<code class="sourceCode cpp">parallel_scheduler_backend</code> to
trigger the completion operations.
<code class="sourceCode cpp">bulk_item_receiver_proxy</code> is derived
from <code class="sourceCode cpp">receiver_proxy</code> and is used for
<code class="sourceCode cpp">bulk_chunked</code> and
<code class="sourceCode cpp">bulk_unchunked</code> customizations that
will also receive notifications from implementations of
<code class="sourceCode cpp">parallel_scheduler_backend</code>
corresponding to different iterations.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> P, <em>class-type</em> Query<span class="op">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>optional<span class="op">&lt;</span>P<span class="op">&gt;</span> try_query<span class="op">(</span>Query q<span class="op">)</span> <span class="add" style="color: #006e28"><ins><span><code class="sourceCode default">const</code></span></ins></span> <span class="kw">noexcept</span>;</span></code></pre></div>
<p><span class="marginalizedparent"><a class="marginalized">5</a></span>
<em>Mandates</em>: <code class="sourceCode cpp">P</code> is a
cv-unqualified non-array object type.</p>
<p><span class="marginalizedparent"><a class="marginalized">6</a></span>
<em>Returns</em>: Let <code class="sourceCode cpp">env</code> be the
environment of the receiver represented by <code class="sourceCode cpp"><span class="op">*</span><span class="kw">this</span></code><span class="add" style="color: #006e28"><ins>and <span><code class="sourceCode default">template &lt;typename T, typename R&gt; R</code></span>
<em>implementation-defined-transform</em><span><code class="sourceCode default">(T&amp;&amp;)</code></span>
an implementation-defined transformation</ins></span>. If:</p>
<ul>
<li><span class="marginalizedparent"><a class="marginalized">(6.1)</a></span>
<code class="sourceCode cpp">Query</code> is not a member of an
implementation-defined set of supported queries; or</li>
<li><span class="marginalizedparent"><a class="marginalized">(6.2)</a></span>
<code class="sourceCode cpp">P</code> is not a member of an
implementation-defined set of supported result types for
<code class="sourceCode cpp">Query</code>; or</li>
<li><span class="marginalizedparent"><a class="marginalized">(6.3)</a></span> the
expression <code class="sourceCode cpp">q<span class="op">(</span>env<span class="op">)</span></code>
is not well-formed<span class="add" style="color: #006e28"><ins>;
or</ins></span><span class="rm" style="color: #bf0303"><del>or does not
have type
<em><span><code class="sourceCode default">cv</code></span></em>
<span><code class="sourceCode default">P</code></span>,</del></span></li>
<li><span class="add" style="color: #006e28"><ins><span class="marginalizedparent"><a class="marginalized">(6.4)</a></span> the
expression
<em>implementation-defined-transform</em><span><code class="sourceCode default">(q(env))</code></span>
is not well-formed or does not have type
<em><span><code class="sourceCode default">cv</code></span></em>
<span><code class="sourceCode default">P</code></span>,</ins></span></li>
</ul>
<p>then returns <code class="sourceCode cpp">nullopt</code>. Otherwise,
returns <code class="sourceCode cpp">q<span class="op">(</span>env<span class="op">)</span></code>.</p>
<p><span class="marginalizedparent"><a class="marginalized">7</a></span>
<em>Remarks</em>: <code class="sourceCode cpp">get_stop_token_t</code>
is in the implementation-defined set of supported queries, and
<code class="sourceCode cpp">inplace_stop_token</code> is a member of
the implementation-defined set of supported result types for
<code class="sourceCode cpp">get_stop_token_t</code>.</p>
<p><span class="add" style="color: #006e28"><ins><span class="marginalizedparent"><a class="marginalized">8</a></span>
<em>Recommended practice</em>: <span><code class="sourceCode default">template &lt;typename T&gt; inplace_stop_token</code></span>
<em>implementation-defined-transform</em><span><code class="sourceCode default">(T&amp;&amp;)</code></span>
should be defined for any
<span><code class="sourceCode default">T</code></span> that models
<span><code class="sourceCode default">stoppable_token</code></span></ins></span></p>
<h1 data-number="4" id="acknowledgments"><span class="header-section-number">4</span> Acknowledgments<a href="#acknowledgments" class="self-link"></a></h1>
<p>Thanks to Tim Song and Tomasz Kamiński for working extra time to
ensure that <span class="citation" data-cites="P2079R10">[<a href="https://wg21.link/p2079r10" role="doc-biblioref">P2079R10</a>]</span> is specified with high
standards. The C++ standard would not have been at the same level of
quality without their love and care.</p>
<p>Thanks to Lewis Baker for constantly pushing to get better and better
solutions to the problems at hand.</p>
<h1 data-number="5" id="bibliography"><span class="header-section-number">5</span> References<a href="#bibliography" class="self-link"></a></h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="1" role="doc-bibliography">
<div id="ref-P2079R10" class="csl-entry" role="doc-biblioentry">
[P2079R10] Lucian Radu Teodorescu, Ruslan Arutyunyan, Lee Howes, Michael
Voss. 2025-06-25. Parallel Scheduler. <a href="https://wg21.link/p2079r10"><div class="csl-block">https://wg21.link/p2079r10</div></a>
</div>
</div>
</div>
</div>
</body>
</html>
